<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe Finder</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Cafe Finder</h1>
        </header>
        
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search for cafes...">
            <button id="search-button">Search</button>
            <button id="locate-me">Use My Location</button>
        </div>
        
        <div class="content">
            <div id="map"></div>
            <div id="results-list">
                <h2>Nearby Cafes</h2>
                <div id="places-list"></div>
            </div>
        </div>
    </div>

    <!-- Secure API client for Google Maps -->
    <script src="secure-api.js"></script>
    <script src="script.js"></script>
    <!-- Google Maps API loading with secure proxy -->
    <script>
        // Check if ad blockers might be causing issues
        function checkForAdBlockers() {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'adblocker-warning';
            warningDiv.style.display = 'none';
            warningDiv.style.position = 'fixed';
            warningDiv.style.top = '0';
            warningDiv.style.left = '0';
            warningDiv.style.width = '100%';
            warningDiv.style.padding = '10px';
            warningDiv.style.backgroundColor = '#fff3cd';
            warningDiv.style.color = '#856404';
            warningDiv.style.textAlign = 'center';
            warningDiv.style.zIndex = '9999';
            warningDiv.innerHTML = 'Ad blocker detected. This may prevent some features from working correctly. ' +
                'Please disable your ad blocker or add this site to your allowlist for the best experience.';
            document.body.appendChild(warningDiv);
            
            // Create a test element to detect ad blockers
            const testElement = document.createElement('div');
            testElement.className = 'ads ad adsbox doubleclick ad-placement carbon-ads';
            testElement.style.height = '1px';
            testElement.style.position = 'absolute';
            testElement.style.left = '-9999px';
            document.body.appendChild(testElement);
            
            // Check if the test element is hidden by an ad blocker
            setTimeout(function() {
                if (testElement.offsetHeight === 0) {
                    document.getElementById('adblocker-warning').style.display = 'block';
                    console.warn('Ad blocker detected. Some Google Maps features may not work correctly.');
                }
                document.body.removeChild(testElement);
            }, 100);
        }

        // Load the Google Maps script securely once the page is ready
        window.addEventListener('load', function() {
            // Check for ad blockers
            checkForAdBlockers();
            
            // Show loading indicator in the map container
            document.getElementById('map').innerHTML = 
                '<div style="display:flex;justify-content:center;align-items:center;height:100%;flex-direction:column;">' +
                '<div style="margin-bottom:20px;">Loading Google Maps...</div>' +
                '<div class="loading-spinner"></div>' +
                '</div>';
            
            // Load Google Maps API securely through our proxy
            SecureAPI.loadMapsApi('initMap', 'places')
                .catch(error => {
                    console.error('Failed to load Google Maps:', error);
                    document.getElementById('map').innerHTML = 
                        '<div style="text-align:center;padding:20px;"><h3>Error Loading Google Maps</h3>' +
                        '<p>There was an error loading Google Maps. Please try again later.</p></div>';
                });
        });
        
        // Define a global error handler for Google Maps API errors
        window.gm_authFailure = function() {
            console.error('Google Maps authentication error');
            const mapDiv = document.getElementById('map');
            if (mapDiv) {
                mapDiv.innerHTML = '<div style="text-align:center;padding:20px;"><h3>Google Maps API Error</h3>' +
                    '<p>There was an error authenticating with Google Maps. Please try again later.</p></div>';
            }
        };
    </script>
</body>
</html>
